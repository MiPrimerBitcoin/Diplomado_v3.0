# Bitcoin c√≥mo Dep√≥sito de Valor y c√≥mo Red de Pagos

- **El doble gasto:** 
Cuando alguien env√≠a la misma ‚Äúmoneda‚Äù dos veces.
- EJEMPLO

    - Digamos que Sarah les debe a Bill y a Tom 0.2 BTC, pero tiene exactamente 0.2 BTC en su billetera. Ella crea dos transacciones simult√°neas en las cuales le manda 0.2 BTC a Bill y tambi√©n 0.2 BTC a Tom. Es como si hubiera escrito un correo electr√≥nico en el que declara su amor y se lo hubiese mandado simult√°neamente a dos personas.
    
    
    - ¬°Las dos transacciones no van a ser confirmadas por la red! Eso ser√≠a un ejemplo de un doble gasto. Pero si tenemos un sistema en el que ning√∫n computador est√° a cargo, ¬øc√≥mo se hace para decidir cu√°l transacci√≥n se rechaza y cu√°l queda escrita permanentemente en la cadena? Bitcoin usa un proceso llamado **miner√≠a**.

## **El problema del doble gasto**

Antes de entrar en detalle, contemplemos lo siguiente: 

*Bitcoin es dinero digital*.  Esto significa que a diferencia del dinero convencional, 

- No puede duplicarse como otro tipo de archivos digitales¬†(fotos, videos, etc.),
    - replicado ,falsificado y/o enviado a m√∫ltiples personas simult√°neamente,
    - o facturado como un cobro doble a trav√©s de una tarjeta de cr√©dito.

*Que beneficios trae esta caracter√≠stica de bitcoin?* Expliquemos con un ejemplo.

- Es com√∫n que las personas almacenen sus recibos y/o mantengan un registro de sus gastos
- Peri√≥dicamente comparan sus cuentas con los saldos bancarios
- y verifican que no haya ninguna discrepancia de gastos.

Por ejemplo:

- Alguien puede darse cuenta que un restaurante cobr√≥ su tarjeta de cr√©dito dos veces;
- Hay dos retiros de $5.08 el 01/26/22. Le han facturado doble por el mismo almuerzo
- Probablemente va o llama al banco para tratar de revertir uno de los pagos,
- En el mejor caso, si el banco acepta su disputa, recuperar√° su dinero en unos meses.
- En el peor, el restaurante se opone a devolver el dinero alegando que hubo 2 compras.

Sigamos explorando ejemplos del d√≠a a d√≠a para ilustrar la idea del ‚Äúdoble gasto‚Äù

D√≠a #1:

- Digamos que Raquel pide un almuerzo en McDonalds por 10 USD.
- Paga en efectivo con dos billetes  de 5 USD.
- El pago queda confirmado instant√°neamente
    - ambas partes han presenciado f√≠sicamente el tr√°mite
        - y ha sido un intercambio sencillo.
- Simple, una hamburguesa a cambio del dinero.

D√≠a #2: 

- Raquel pide el mismo almuerzo y tiene dos billetes de 5 USD de nuevo,
- pero uno es original y otro falso (una copia exacta).  Los entrega como forma de pago.
- Siendo los n√∫meros de serie id√©nticos:
    - el cajero f√°cilmente podr√≠a ver que uno es falso,
    - o simplemente aceptarle el pago como el d√≠a anterior.
- El cajero, estando en una jornada ajetreada, acepta el pago sin mirar los billetes

D√≠a #3 (Raquel estuvo de buenas, pero le da miedo volver a McDonalds) 

- Ahora, va a tratar de replicar su bitcoin como replic√≥ su billete en McDonalds.
- Ella le debe 0.2BTC tanto a Jaime como a Pepe, pero s√≥lo tiene 0.2 BTC en su monedero.
- Raquel abre su monedero en su tel√©fono y en el de su mam√° con su frase semilla.
- Desde su tel√©fono manda 0.2 BTC a Jaime
- Desde el tel√©fono su mam√° manda 0.2 BTC a Pepe
- Se asegura de mandar las dos transacciones exactamente al mismo tiempo.
- Dos nodos diferentes reciben las dos transacciones
    - Recordemos que Raquel ten√≠a s√≥lo 0.2 BTC en su monedero para gastar.

- ¬°Los nodos de la red se dan cuenta y una de las dos transacciones se rechaza!
- Pero c√≥mo?  Si tenemos un sistema en el que ning√∫n computador est√° a cargo, ¬øc√≥mo se hace para decidir cu√°l transacci√≥n se rechaza y cu√°l queda escrita inalteradamente en la cadena de bloques?

- Para lograr esto, Satoshi Nakamoto logr√≥ encontrar un mecanismo exitoso que  :
    - revisa si una transacci√≥n es v√°lida o no,
    - de manera consensuada entre todos los participantes en la red,
    - antes de agregarla en la cadena de bloques
- Una soluci√≥n ingeniosa a problemas como los mencionados anteriormente

*C√≥mo funciona?*

## Grupo de memoria o mempool

- Antes de que cualquier transacci√≥n se pueda  ejecutar y fijar en un bloque,
    - entrar√° a un √°rea de espera llamada ‚Äúmempool‚Äù (grupo de memoria).

**¬ø***Qu√© es y que sucede con las transacciones que entran aqu√≠?*

- Un sitio donde existen miles de transacciones verificadas pero no confirmadas
- No  existe una Mempool global; cada uno de los nodos debe:
    - verificar la validez de las transacciones antes de incluirlas en su Mempool
    - propagar transacciones verificadas a los nodos vecinos
    - rechazar transacciones inv√°lidas

> Aqu√≠ https://dailyblockchain.github.io/  se puede observar c√≥mo se dispersan r√°pidamente las transacciones v√°lidas de nodo a nodo.
 


- Los nodos deben decidir si las transacciones son v√°lidas o no
    - Si son aceptadas,
        - esperan que un minero la seleccione y las adicione en el siguiente bloque
            - eventualmente se graban **permanentemente** en la base de datos compartida,
    - De lo contrario, se pueden rechazar si :
        - existe un conflicto con otra transacci√≥n,
        - si no hay suficientes fondos para transferir o
        - si la firma no es v√°lida y no puede comprobar que se puede gastar dicho BTC,
    - Algunas transacciones simplemente se quedan en el √°rea de espera
        - por hasta 72 horas, hasta que por fin se rechazan
            - ya que no agregan un incentivo monetario suficientemente atractivo

La mempool proporciona una capa adicional de seguridad y resistencia contra¬†*ataques DDoS.*  

- cuando una red se inunda con transacciones min√∫sculas,
    - provocando una congesti√≥n inmanejable.

## Actividad-Transacciones Verificadas pero no Confirmadas

https://bits.monospace.live/

https://chainflyer.bitflyer.jp/

A continuaci√≥n podemos ver una transacci√≥n real sin confirmar:

- Un identificador √∫nico ( la huella digital de la transacci√≥n),
- el espacio de memoria que ocupa,
- la comisi√≥n que se paga
- el monto de la transferencia
    
    TxID: a434948b2de9de18398294f84e42436ec59fb86faf34a21052bd640a97cd94b7d
    ___input	‚ü∂. ___outputs
    Size: _____ vbytes (Espacio de memoria que ocupa)
    Fee rate: 27.01 sats/vbyte (Rata de Comisi√≥n/ vbyte actual)
    Fee: ______sats (Comisi√≥n de la transacci√≥n)
    Total value: ‚Çø _______ ‚âà $ ______USD (Valor total de la transacci√≥n)
    

Podr√≠amos analizar otra u otras transacciones? 

- Es de mayor o menor monto?
- Los participantes pagaron una comisi√≥n m√°s alta o m√°s baja?
- Cual transacci√≥n ser√° m√°s probable encontrar en el siguiente bloque? Porqu√©?
- Qu√© querr√° decir cuando un bloque se cae hacia el abismo?
- Que quiere decir cuando se confirma una transacci√≥n?‚Ä¶. Pr√≥xima clase

## **La Red de Bitcoin (On-Chain)**

- Est√° compuesta por los nodos de Bitcoin‚Ä¶
    - Aquellos equipos computacionales que se adhieren a un sistema de reglas (Bitcoin Core).
        - Se comunican entre s√≠ a trav√©s del ciberespacio convirti√©ndolos en una red.
            - Cada uno de los cuales ejecuta su propia versi√≥n del software Bitcoin.


Desde estos puntos de conexi√≥n se puede crear, enviar, y recibir informaci√≥n (i.e. transacciones)

- Existen diferentes tipos de nodos; cada uno ejerce un papel diferente en la red

## Nodos Completos

- Ejecutan el software de bitcoin

Tienen autonom√≠a de tomar sus propias decisiones, sin embargo, a trav√©s del consenso,

- toman las mismas decisiones, convirti√©ndolos en una red descentralizada confiable y segura
- Los nodos completos tienen tres funciones:
    1. **Compartir informaci√≥n (a sus nodos vecinos)**


- [ ]  Hay dos tipos de transacciones que comparten los nodos:
    1. *Transacciones frescas*: 
    - Estas van directamente a la mempool**.**
    - Los nodos se encargan de verificar o rechazar estas transacciones.
        - Se basan en el historial de la blockchain y el conjunto de reglas del software
    - Retransmiten las transacciones v√°lidas a sus nodos vecinos
        - Nadie quiere recibir transacciones defectuosas o maliciosas

b. *Transacciones confirmadas*: 

- transacciones que han sido "**confirmadas**" y escritas en un bloque.
- Estas se agrupan y forman los bloques; no se comparten individualmente.


1. **Guardar una copia de las transacciones confirmadas.** 
- Mantienen una copia completa de todos los bloques en la cadena de bloque,
- Cada **confirmaci√≥n** reduce¬†exponencialmente *e*l riesgo de que la transacci√≥n sea revertida .

https://mempool.space/ (Los bloques morados -debajo est√°n todas las transacciones)

1. **Validar los bloques y llegar a un consenso con los otros nodos.** 
- Todos los nodos participantes deben aceptar un√°nimemente la informaci√≥n que contiene un bloque entero antes de incluirlo en la cadena de bloques.
- Una copia de la cadena de bloques para su custodia y la comparte con otros nodos.

El estatus de sus transacciones frescas y confirmadas se pueden localizar en la red. C√≥mo ?

- Los exploradores de bloques son una ventana a todas las transacciones cadena de bloques
- Permiten comprobar el saldo de cada direcci√≥n, ver los detalles de cada transacci√≥n y m√°s

**Actividad**:    Exploremos uno de ellos:

  https://www.blockchain.com/explorer?view=btc

Vamos al link de Bitcoin donde podemos observar: 

- el monto total que se transmite,
- cuantas entradas y salidas hay
- el tama√±o (o la memoria que ocupa en el bloque),
- el ID de una transacci√≥n aleatoria
- el estado de la transacci√≥n y,
- si la transacci√≥n ya ha sido confirmada, muestra el n√∫mero total de confirmaciones.

-Latest Transactions= √öltimas Transacciones

-Latest Blocks=√öltimos Bloques

Qu√© informaci√≥n reconoces? Cual te sorprende? Cu√°l es el valor de la √∫ltima  transacci√≥n? Podemos ver si ya est√° confirmada?

- no todos los usuarios tienen suficiente espacio en su disco duro para convertirse en uno
    - de ser ese el caso, simplemente se puede descargar un monedero
        - y realizar transferencias o guardar BTC a largo plazo

### Software -**Bitcoin Core**:

Software original creado por Satoshi Nakamoto-

- Dise√±ado para conectarse a otras personas que ejecutan el mismo programa,
    - creando una red de computadoras que se comunican entre s√≠.
- Su prop√≥sito es que al descargarlo, todos trabajen con el mismo conjunto de reglas
    - para validar transacciones
    - y contribuir con la seguridad y la descentralizaci√≥n del sistema
- Quien lo ejecute, puede instalarlo como cualquier otro programa de computador
    - descarga y crea una copia adicional de la cadena entera de bloques,
    - puede ayudar a transmitir transacciones a otras computadoras.
- Siempre y cuando haya acceso a internet, no se necesita ning√∫n permiso para:
    - descargarlo y/o utilizarlo libremente
    - transferir bitcoin a otro monedero o recibir de alguien m√°s,
    - verificar de forma demostrable la emisi√≥n de la oferta,
    - conocer el historial de transacciones y los propietarios de cada bitcoin.
    

üí° **C√≥digo fuente abierto:** Cualquier persona puede ver, **proponer cambios**, **modificar** y distribuir como mejor le parezca. Es comparable a ir a un restaurante y tener acceso a las recetas de tus comidas favoritas (el c√≥digo)‚Ä¶ pero luego puedes hacerlas y agregar o quitar cualquier ingrediente que desees y perfeccionarlas.


- Decenas de¬†expertos en software y criptograf√≠a, trabajan en su mantenimiento y mejora.
- Quien propone una actualizaci√≥n en el software,
    - requiere el consenso de la mayor√≠a de los para implementarla

### **‚ÄúLightning Network‚Äù (Off-Chain):**

## **Cu√°l es la diferencia entre la Capa 1  o Capas Base y la Capa 2?**

¬øQu√© haces con una carretera segura pero congestionada? Simple: conectas una carretera para descargar el tr√°fico. Esta es exactamente la diferencia entre las redes blockchain de Capa 1 y Capa 2.

- Muchas piezas tecnol√≥gicas importantes de Bitcoin e incluso muchas transacciones no ocurren dentro de la "cadena de bloques"
- **Bitcoin** es revolucionario ya que es  la ***capa base*** del internet descentralizado, pero,
    - tiene un problema fundamental de escalabilidad.
    - Las transacciones de Bitcoin pueden ser lentas y caras.
        - Se argumenta que bitcoin no se puede usar como medio de pago
            - por ser lento y caro en micro pagos.
                - Existen transacciones de US$1 o US$2 que terminan costando m√°s de US$5 cuando se usa la red principal.
                - Visa procesa hasta 65.000 transacciones por segundo,
                    - mientras que la red Bitcoin solo puede manejar 7 tps.

Ah√≠ es donde la magia de las *soluciones de **capa dos*,** como **Lightning**, ha venido al rescate.

- Con Lightning Network, Bitcoin tiene el potencial de ser la moneda de la era digital‚Ä¶
    - r√°pida, inmutable y descentralizada.

https://youtu.be/lD8WQbS8-T8

- **Lightning**, es un conjunto de reglas (contratos inteligentes), construido encima de Bitcoin,
    - que permite transacciones instant√°neas,
    - de alto volumen y
    - desconectadas de la red principal.
    - No es necesario registrar todas las transacciones en la red,
    - sino en una red alterna m√°s eficiente.
    - Brinda toda la seguridad de Bitcoin sin algunos de sus inconvenientes
        - pero con diferentes tipos de compensaciones
    - Ofrece m√°s privacidad.
    - Lightning aborda los problemas de escalabilidad de Bitcoin.



**Analog√≠a:**

- Un hu√©sped se registra en un hotel; de anticipado le piden su tarjeta de cr√©dito
    - para cubrir los cargos de habitaci√≥n y tarifas imprevistas de la estad√≠a.
- Es m√°s eficiente y menos costoso que cargar la tarjeta cada vez que incurre en un gasto.
- El hotel lleva un registro de todos los gastos de el cliente.
    - Existe una farmacia y una peluquer√≠a independientes dentro del hotel
        - El hu√©sped compra productos, usa servicios y firma la deuda a su habitaci√≥n.
        - El hotel cobra una comisi√≥n por intermediar el pago entre el hu√©sped y el negocio.
- Si el hu√©sped tiene alg√∫n problema o una queja,
    - se le descuenta la cantidad necesaria de su cuenta
- La tarjeta s√≥lo se carga despu√©s de la estad√≠a
    - cuando el hu√©sped haya verificado que los cargos y el saldo sean correctos.

**Lightning Network** funciona de manera similar pero diferente. C√≥mo  as√≠?

- La analog√≠a es precisa con la exclusi√≥n de la necesidad de confianza
    - Este es un malentendido muy com√∫n de LN: no es un sistema de cr√©dito.
        - Las transacciones de LN no son pagar√©s:
            - son transacciones de Bitcoin v√°lidas que mueven UTXO reales
- En lugar de darle a alguien una tarjeta de cr√©dito y dejar una cuenta abierta,
    - dos nodos pueden abrir un **canal de pago, o** una ruta de transferencia
    - Las partes pueden realizar tantas transacciones  veces como lo deseen,
        - manteniendo su saldo siempre actualizado.
    - Cuanto m√°s grande un canal,
        - mayor la cantidad de bitcoin que se puede transferir en ambas direcciones
    - Se puede construir rutas con todos aquellos con los que se hacen transacciones.
    - Cuantos m√°s canales,
        - m√°s conexiones y mejores atajos para llegar a ciertos destinos.
    - Si existe una ruta directa,
        - todo es sencillo y se hace una transaccion segun el tama√±o del canal.
    - Si la conexi√≥n es a trav√©s de un tercero (un puente),
        - se debe pagar un peaje por pasar
    - Para abrir un canal nuevo, ambos nodos pagan un fee peque√±o a los mineros
        - No se necesita actualizar y verificar cada transacci√≥n en la red,
            - Esto ser√≠a costoso y tomar√≠a mucho tiempo.
        - Por el contrario, se aprueba cada movimiento con ambas firmas digitales
    - Cuando cualquiera de las partes decide cerrar el canal,
        - puede transmitir unilateralmente la √∫ltima transacci√≥n a la red Bitcoin.

Mira una visualizaci√≥n:

https://lnrouter.app/graph/zero-base-fee

- Si A tiene un canal abierto con B y B tiene un canal abierto con C, A puede enviar BTC a C a trav√©s de B sin necesidad de confiar o conocer a B.

Actividad:

Miremos un simulador:
https://www.robtex.com/lnemulator.html?conf=A5-5B,B5-5C&send=A2C

- El uso de Lightning es tan barato y r√°pido como el env√≠o de un correo electr√≥nico
    - con el beneficio adicional de la naturaleza segura y sin confianza de Bitcoin.
        - S√≥lo las dos personas que mantienen dinero en un canal abierto saben
            - cu√°nto, qu√© tan a menudo y cu√°ndo se mueve ese dinero.



- En comparaci√≥n, si se hacen 3 transacciones ‚Äúen cadena‚Äù, es decir,
    - se quedan en la  capa base,
        - hubieran sido mucho m√°s lentas y caras.
- Cada una de estas transacciones tendr√≠a que involucrar a todos los participantes de la red
    - Se podr√≠a visualizar de la siguiente manera:
    
   

